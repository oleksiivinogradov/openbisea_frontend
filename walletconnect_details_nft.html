<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossOrigin="anonymous">
<script type="text/javascript"
        src="https://platform-api.sharethis.com/js/sharethis.js#property=609d3a22ccbbe50012c02cb7&product=inline-share-buttons"
        async="async"></script>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

<div class="container" style="display: table;margin-right: auto;margin-left: auto;text-align:center;">
    <div class="row">
        <div class="col-md-12">
            <div class="sharethis-inline-share-buttons" style="display: table;margin-right: auto;margin-left: auto;"></div>

            <h1>NFT details</h1>
            <div class="alert alert-danger" id="alert-error-https" style="display: none">
                You can run this example only over HTTPS connection.
            </div>
            <img style="max-width: 240px;height:auto;border-radius: 25px;border: 2px solid #F2BE4B;" id="image" src="">
            <br>
            <br>

            <model-viewer src="" id="threed" alt="demo" style="display: none;border-radius: 25px;border: 2px solid #F2BE4B;width: 800px; height: 600px;" auto-rotate camera-controls></model-viewer>

            <br>
            <br>

            <textarea type="text" readonly="readonly" name="name" value="" id="name" style="max-width: 240px;height:auto;border-radius: 5px;border:2px solid #F2BE4B;-webkit-box-shadow:0 0 6px #F2BE4B;-moz-box-shadow:0 0 5px #F2BE4B;box-shadow:0 0 5px #F2BE4B;color:black"></textarea>
            <br>
            <br>

            <textarea  id="desc" name="desc" readonly="readonly" placeholder="description" style="border-radius: 10px;width:250px;height:150px;border:2px solid #F2BE4B;-webkit-box-shadow:0 0 6px #F2BE4B;-moz-box-shadow:0 0 5px #F2BE4B;box-shadow:0 0 5px #F2BE4B;color:black">Loading... </textarea>
            <br>
            <br>

            <input type="text" placeholder="Artist" readonly="readonly"  name="artist" value="" id="artist" style="border-radius: 10px;border:1px solid #F2BE4B;-webkit-box-shadow:0 0 6px #F2BE4B;-moz-box-shadow:0 0 5px #F2BE4B;box-shadow:0 0 5px #F2BE4B;color:black"/>
            <br>
            <br>

            <textarea type="text" readonly="readonly"  placeholder="Public profile link" name="public_profile_link" value="" id="public_profile_link" style="border-radius: 10px;border:1px solid #F2BE4B;-webkit-box-shadow:0 0 6px #F2BE4B;-moz-box-shadow:0 0 5px #F2BE4B;box-shadow:0 0 5px #F2BE4B;color:black"></textarea>
            <br>
            <br>
            <p id="owner">NFT owner loading...</p>

            <button class="btn btn-primary" id="create-auction" style="display: none;background-color: #fcbd24;color:black">
                Create auction
            </button>

            <button class="btn btn-primary" id="cancel-auction" style="display: none;background-color: #fcbd24;color:black">
                Cancel auction
            </button>

            <div id="prepare">
                <p>No wallet connected. Connect wallet to show accounts and their BNB balances.</p>
                <button class="btn btn-primary" id="btn-connect" style="background-color: #fcbd24;color:black">
                    Connect wallet
                </button>
                <br>
                <br>

            </div>
            <div id="whitelist" style="display: none; text-align: center;">
                <p>Contract not whitelisted. Please press Whitelist to add.</p>
                <button class="btn btn-primary" id="btn-whitelist" style="background-color: #fcbd24;color:black">
                    Whitelist contract
                </button>
                <br>
                <br>
            </div>


            <div id="connected" style="display: none; text-align: center;">

                <table class="table table-listing">
                    <thead>
                    <th style="text-align: center;">Name</th>
                    <th style="text-align: center;">Image</th>
                    <th style="text-align: center;">Price</th>
                    <th style="text-align: center;">Deadline</th>
                    <th style="text-align: center;">Bid amount</th>
                    <th style="text-align: center;">Allow</th>
                    <th style="text-align: center;">Bid</th>
                    </thead>

                    <tbody id="auctions">
                    </tbody>
                </table>



                <span id="progress" style="color:#fcbd24;display: none;"> Transaction in progress ...</span>

                <br>
                <div id="resultstrans" style="text-align: center;">
                    <button class="btn btn-primary" id="buy-obs-result" style="display: none;background-color: white;color:black;" > Check transaction status </button>
                </div>

                <hr>

                <div id="network">
                    <p>
                        <strong>Connected blockchain:</strong> <span id="network-name"></span>
                    </p>

                    <p>
                        <strong>Selected account:</strong> <span id="selected-account"></span>
                    </p>
                    <button class="btn btn-primary" id="btn-disconnect" style="background-color: #fcbd24;color:black">
                        Disconnect wallet
                    </button>

                </div>

                <hr>

                <h3>All account balances</h3>

                <table class="table table-listing">
                    <thead>
                    <th>Address</th>
                    <th>BNB balance</th>
                    </thead>

                    <tbody id="accounts">
                    </tbody>
                </table>

                <p>Please try to switch between different accounts in your wallet if your wallet supports this functonality.</p>

            </div>
        </div>
    </div>

    <!-- We use simple <template> templating for the example -->
    <div id="templates" style="display: none">
        <template id="template-balance">
            <tr>
                <th class="address"></th>
                <td class="balance"></td>
            </tr>
        </template>
        <template id="template-auction">
            <tr>
                <th class="name"></th>
                <th class="image">
                    <button class="btn btn-primary" id="openImage" style="background-color: #fcbd24;color:black;"onclick="onOpenImageClick(this)"> Image </button>
                </th>
                <td class="price"></td>
                <td class="deadline"></td>
                <th class="bidAmount">
                    <input type="text" placeholder="bid amount" name="Amount" value="" style="text-align: right; color:black;border:1px solid #fafafa;-webkit-box-shadow:0 0 6px #fcbd24;-moz-box-shadow:0 0 5px #fcbd24;box-shadow:0 0 5px #fcbd24;"/>
                </th>
                <th class="allow">
                    <button class="btn btn-primary" style="background-color: #fcbd24;color:black;display: none" onclick="onAllowClick(this)"> Approve </button>
                </th>
                <th class="bid">
                    <button class="btn btn-primary" style="background-color: #fcbd24;color:black;" onclick="onBidClick(this)"> Bid </button>
                </th>
            </tr>
        </template>
    </div>
</div>

<!--
  Use unpkg CDN to load all NPM packages to vanilla Javascript - read more at http://unpkg.com
  On your deployment, you properly either want to use a preprocessing tool like webpack
  to include these files, or extract NPM archives and manually host the files inside.
  TODO: Pin down all versions.
-->

<script type="text/javascript" src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
<script type="text/javascript" src="https://unpkg.com/evm-chains@0.2.0/dist/umd/index.min.js"></script>
<script type="text/javascript"
        src="https://unpkg.com/@walletconnect/web3-provider@1.2.1/dist/umd/index.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/fortmatic@2.0.6/dist/fortmatic.js"></script>
<script type="text/javascript" src="all.js"></script>

<script>
  "use strict";

  /**
   * Example JavaScript code that interacts with the page and Web3 wallets
   */
  function getQueryParams (qs) {
    qs = qs.split('+').join(' ');

    var params = {},
      tokens,
      re = /[?&]?([^=]+)=([^&]*)/g;

    while (tokens = re.exec(qs)) {
      params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
    }

    return params;
  }

  // Unpkg imports
  const Web3Modal = window.Web3Modal.default;
  const WalletConnectProvider = window.WalletConnectProvider.default;
  const Fortmatic = window.Fortmatic;
  const evmChains = window.evmChains;

  // Web3modal instance
  let web3Modal

  // Chosen wallet provider given by the dialog window
  let provider;

  // Address of the selected account
  let selectedAccount;

  //bscan
  let resultURL;
  /**
   * Setup the orchestra
   */

  let tokenIDsaved;
  let contractSaved;
  let isTestnetSaved;

  let ownerOftoken;

  function init () {

    console.log("Initializing example");
    console.log("WalletConnectProvider is", WalletConnectProvider);
    console.log("Fortmatic is", Fortmatic);
    console.log("window.web3 is", window.web3, "window.ethereum is", window.ethereum);

    // Check that the web page is run in a secure context,
    // as otherwise MetaMask won't be available
    if (location.protocol !== 'https:') {
      // https://ethereum.stackexchange.com/a/62217/620
      const alert = document.querySelector("#alert-error-https");
      alert.style.display = "block";
      document.querySelector("#btn-connect").setAttribute("disabled", "disabled")
      return;
    }

    // Tell Web3modal what providers we have available.
    // Built-in web browser provider (only one can exist as a time)
    // like MetaMask, Brave or Opera is added automatically by Web3modal
    const providerOptions = {
      walletconnect: {
        package: WalletConnectProvider,
        options: {
          // Mikko's test key - don't copy as your mileage may vary
          infuraId: "bb7b522604e54a2f8ad251e7417b2355",
        }
      },

      // fortmatic: {
      //   package: Fortmatic,
      //   options: {
      //     // Mikko's TESTNET api key
      //     key: "pk_test_391E26A3B43A3350"
      //   }
      // }
    };

    web3Modal = new Web3Modal({
      cacheProvider: false, // optional
      providerOptions, // required
      disableInjectedProvider: false, // optional. For MetaMask / Brave / Opera.
    });

    console.log("Web3Modal instance is", web3Modal);
    let attempts = 0;
    let sendOrderStatus = setInterval(async function () {
      if (window.BinanceChain !== undefined) {
        clearInterval(sendOrderStatus);
        console.log("YES window.BinanceChain ");

        const BinanceChain = window.BinanceChain;
        provider = BinanceChain;

        let currentChainId = BinanceChain.chainId;
        console.log('currentChainId:' + currentChainId);

        BinanceChain.on('chainChanged', handleChainChanged);

        function handleChainChanged (_chainId) {
          // We recommend reloading the page, unless you must do otherwise
          window.location.reload();
        }

        let currentAccount = null;
        BinanceChain
          .request({ method: 'eth_accounts' })
          .then(handleAccountsChanged)
          .catch((err) => {
            // Some unexpected error.
            // For backwards compatibility reasons, if no accounts are available,
            // eth_accounts will return an empty array.
            console.error(err);
          });

        BinanceChain.on('accountsChanged', handleAccountsChanged);

        function handleAccountsChanged (accounts) {
          if (accounts.length === 0) {
            // Binance Chain Wallet is locked or the user has not connected any accounts
            console.log('Please connect to Binance Chain Wallet.');
          } else if (accounts[0] !== currentAccount) {
            currentAccount = accounts[0];
            console.log('currentAccount:' + currentAccount);
            fetchAccountData()
            // Do any other work!
          }
        }

        BinanceChain
          .request({ method: 'eth_requestAccounts' })
          .then(handleAccountsChanged)
          .catch((err) => {
            if (err.code === 4001) {
              // EIP-1193 userRejectedRequest error
              // If this happens, the user rejected the connection request.
              console.log('Please connect to MetaMask.');
            } else {
              console.error(err);
            }
          });

      } else {
        console.log("NO window.BinanceChain ");
        attempts = attempts + 1;
        if (attempts > 5) {
          clearInterval(sendOrderStatus);
        }
      }
    }, 5000);

    updatePage();
  }

  async function updatePage () {
    let query = getQueryParams(document.location.search);
    tokenIDsaved = query.tokenID;
    contractSaved = query.contract;
    isTestnetSaved = query.testnet;
    console.log("query is", query);
    console.log("isTestnetSaved is", isTestnetSaved);
    let url = 'https://bsc-dataseed1.binance.org';
    if (isTestnetSaved === '1') {
      url = 'https://data-seed-prebsc-1-s2.binance.org:8545/'
    }
    const web3 = new Web3(new Web3.providers.HttpProvider(url));
    console.log("Web3 instance is", web3);

    // Get connected chain id from Ethereum node
    const chainId = await web3.eth.getChainId();
    console.log("Web3 chainId is", chainId);

    let nftContractAddress = "0xb861DF245fc18483235D9C11b87d8A76F4678e08";
    if (chainId === 97) nftContractAddress = "0x873783a6c4586c196adfdb15c8acdc576b799938";
    if (contractSaved !== undefined) {
      nftContractAddress = contractSaved
    }
    const erc721abi = _erc721abi;

    let nftContract = new web3.eth.Contract(erc721abi, nftContractAddress);
    ownerOftoken = await nftContract.methods.ownerOf(query.tokenID + "").call().catch(function (error) {console.log('ownerOf:' + error)});

    let tokenURI = await nftContract.methods.tokenURI(query.tokenID + "").call().catch(function (error) {console.log('tokenURI:' + error)});
    console.log("tokenURI is", tokenURI);

    if (tokenURI.includes("ipfs://ipfs/")) {
      tokenURI = tokenURI.replace('ipfs://ipfs/', 'https://ipfs.io/ipfs/');
    } else {
      tokenURI = tokenURI.replace('ipfs://', 'https://ipfs.io/ipfs/');
    }
    console.log("tokenURI after", tokenURI);

    let response = await fetch(tokenURI);
    if (response.ok) { // если HTTP-статус в диапазоне 200-299
      // получаем тело ответа (см. про этот метод ниже)
      let tokenMetadata = await response.json();
      console.log("tokenMetadata", tokenMetadata);
      if (ownerOftoken.toLowerCase() === "0x1d2dfE8D85ddD235cb48a1282d45444543313A5B".toLowerCase()) {
        document.querySelector("#owner").textContent = "NFT owner is OpenBiSea Auction contract, check auction list bellow.";
      } else {
        document.querySelector("#owner").textContent = "NFT owner is " + ownerOftoken;
      }
      console.log("ownerOftoken", ownerOftoken);
      if (tokenMetadata.media !== undefined) {
        document.querySelector("#threed").style.display = "inline-block";
        document.querySelector("#threed").src = tokenMetadata.media.uri.replace('ipfs://', 'https://ipfs.io/ipfs/');
      }
        if (tokenMetadata.image !== undefined) {
          tokenMetadata.image.replace('ipfs://', 'https://ipfs.io/ipfs/');
          document.querySelector("#image").src = tokenMetadata.image.replace('ipfs://', 'https://ipfs.io/ipfs/');
        }

      document.querySelector("#name").value = tokenMetadata.name;
      if (tokenMetadata.description !== undefined) document.querySelector("#desc").value = tokenMetadata.description;
      else document.querySelector("#desc").style.display = "none"

      if (tokenMetadata.properties !== undefined) document.querySelector("#artist").value = tokenMetadata.properties.artist;
      else document.querySelector("#artist").style.display = "none"
      if (tokenMetadata.properties !== undefined) document.querySelector("#public_profile_link").value = tokenMetadata.properties.public_profile_link;
      else document.querySelector("#public_profile_link").style.display = "none"
      // document.querySelector("#description").textContent = tokenMetadata.description;
      console.log("document.querySelector(#name)", document.querySelector("#description"));

    }
  }

  let auctionsNormalized = {};

  /**
   * Kick in the UI action after Web3modal dialog has chosen a provider
   */
  async function fetchAccountData () {

    auctionsNormalized = {};
    // Get a Web3 instance for the wallet
    const web3 = new Web3(provider);

    console.log("Web3 instance is", web3);

    // Get connected chain id from Ethereum node
    const chainId = await web3.eth.getChainId();
    // Load chain information over an HTTP API
    const chainData = evmChains.getChain(chainId);
    document.querySelector("#network-name").textContent = chainData.name;

    // Get list of accounts of the connected wallet
    const accounts = await web3.eth.getAccounts();

    // MetaMask does not give you all accounts, only the selected account
    console.log("Got accounts", accounts);
    selectedAccount = accounts[0];

    if (ownerOftoken !== undefined && selectedAccount !== undefined && ownerOftoken.toLowerCase() === selectedAccount.toLowerCase()) {
      document.querySelector("#create-auction").style.display = "inline-block";
      document.querySelector("#cancel-auction").style.display = "inline-block";
      console.log("ownerOftokens", ownerOftoken);
    }

    document.querySelector("#selected-account").textContent = selectedAccount;

    // Get a handl
    const template = document.querySelector("#template-balance");
    const accountContainer = document.querySelector("#accounts");

    // Purge UI elements any previously loaded accounts
    accountContainer.innerHTML = '';

    // Go through all accounts and get their ETH balance
    const rowResolvers = accounts.map(async (address) => {
      const balance = await web3.eth.getBalance(address);
      // ethBalance is a BigNumber instance
      // https://github.com/indutny/bn.js/
      const ethBalance = web3.utils.fromWei(balance, "ether");
      const humanFriendlyBalance = parseFloat(ethBalance).toFixed(4);
      // Fill in the templated row and put in the document
      const clone = template.content.cloneNode(true);
      clone.querySelector(".address").textContent = address;
      clone.querySelector(".balance").textContent = humanFriendlyBalance;
      accountContainer.appendChild(clone);
    });

    // Because rendering account does its own RPC commucation
    // with Ethereum node, we do not want to display any results
    // until data for all accounts is loaded
    await Promise.all(rowResolvers);

    let openbiseaAddress = '0x7b1AC460c155ABb6b1D02b543952426A6aaF6b72';

    if (chainId === 97) openbiseaAddress = "0x66Ddd56AB8F961a31Ef344086589D53Ee0b6944a";

    const erc721abi = _erc721abi;

    const openbiseaABI = _openbiseaABI;
    const openbisea = new web3.eth.Contract(openbiseaABI, openbiseaAddress);

    const openBiSeaAuctionAbi = _openBiSeaAuctionAbi;
    const openBiSeaAuctionAddressTestnet = "0xA72821226E7ac461A3CA30434f3D4671c8A3DC37";
    const openBiSeaAuctionAddressMainnet = "0x1d2dfE8D85ddD235cb48a1282d45444543313A5B";
    let openBiSeaAuctionAddress = openBiSeaAuctionAddressMainnet;
    if (chainId === 97) openBiSeaAuctionAddress = openBiSeaAuctionAddressTestnet;
    let openBiSeaAuctionContract = new web3.eth.Contract(openBiSeaAuctionAbi, openBiSeaAuctionAddress);

    let nftContractAddress = "0xb861DF245fc18483235D9C11b87d8A76F4678e08";
    if (chainId === 97) nftContractAddress = "0x4F59D55D1c91fFD3267d560C37605409A7c885b9";
    if (contractSaved !== undefined) {
      nftContractAddress = contractSaved
      let isContractNFTWhitelisted = await openBiSeaAuctionContract.methods.isContractNFTWhitelisted(contractSaved).call().catch(function (error) { console.log('isContractNFTWhitelisted:' + error) });
      console.log('isContractNFTWhitelisted', isContractNFTWhitelisted);
      if (isContractNFTWhitelisted === false) {
        document.querySelector("#whitelist").style.display = "inline-block";
      }
    }
    let nftContract = new web3.eth.Contract(erc721abi, nftContractAddress);

    let auctions = await openBiSeaAuctionContract.methods.getNFTsAuctionList(nftContractAddress).call().catch(function (error) { console.log('getNFTsAuctionList:' + error) });
    console.log('auctions', auctions);
    const templateAuction = document.querySelector("#template-auction");
    const auctionsContainer = document.querySelector("#auctions");
    auctionsContainer.innerHTML = '';
    let index = 1;
    let now = Math.floor(Date.now() / 1000);
    const rowResolversAuction = auctions.map(async (auction) => {
      // console.log('auction',auction);
      let seller = await openBiSeaAuctionContract.methods.sellerAddressFor(auction).call().catch(function (error) { console.log('sellerAddressFor:' + error) });
      // console.log('seller',seller);

      let auctionBN = web3.utils.toBN(auction);
      let sellerBN = web3.utils.toBN(seller);
      var tokenID = auctionBN.sub(sellerBN).toNumber() + '';
      console.log('compare tokenID', tokenID);
      console.log('with tokenIDsaved', tokenIDsaved);
      if (tokenIDsaved + '' === tokenID) {
        let auctionInfo = await openBiSeaAuctionContract.methods.getAuction(nftContractAddress, tokenID).call().catch(function (error) { console.log('getAuction:' + error) });
        console.log('auctionInfo ', auctionInfo);
        if (auctionInfo.seller.toLowerCase() === selectedAccount.toLowerCase()) {
          document.querySelector("#cancel-auction").style.display = "inline-block";
        }
        let tokenURI = await nftContract.methods.tokenURI(tokenID).call().catch(function (error) {console.log('tokenURI:' + error)});
        if (tokenURI.includes("ipfs://ipfs/")) {
          tokenURI = tokenURI.replace('ipfs://ipfs/', 'https://ipfs.io/ipfs/');
        } else {
          tokenURI = tokenURI.replace('ipfs://', 'https://ipfs.io/ipfs/');
        }
        let response = await fetch(tokenURI);

        if (response.ok) { // если HTTP-статус в диапазоне 200-299
          // получаем тело ответа (см. про этот метод ниже)
          let tokenMetadata = await response.json();
          // console.log('tokenMetadata ', tokenMetadata);
          const clone = templateAuction.content.cloneNode(true);
          clone.querySelector(".name").textContent = tokenMetadata.name;
          // clone.querySelector(".image").textContent = 'image';
          // clone.querySelector(".image").href = tokenMetadata.image.replace('ipfs://','https://ipfs.io/ipfs/');
          const priceFloat = parseFloat(await web3.utils.fromWei(auctionInfo.price))
          let price = priceFloat + ' BNB';
          if (auctionInfo.isUSD === true) price = priceFloat + " USD";
          clone.querySelector(".price").textContent = price;
          clone.querySelector(".bidAmount").children[0].value = Math.round((priceFloat + 0.00001) * 100000) / 100000;

          if (auctionInfo.isUSD === true) {
            clone.querySelector(".allow").children[0].style.display = "block"
            clone.querySelector(".bid").children[0].setAttribute("disabled", "disabled")
          }
          var deadline = new Date(parseInt(auctionInfo.deadline) * 1000);

          if (parseInt(auctionInfo.deadline) < now) {
            clone.querySelector(".bid").children[0].textContent = "Buy now";
            console.log('clone.querySelector(".bid").children[0] ', clone.querySelector(".bid").children[0]);
            let deadlineText = timeSince(auctionInfo.deadline);
            clone.querySelector(".deadline").textContent = deadlineText;
          } else {
            let dur = duration(deadline, Date.now());
            clone.querySelector(".deadline").textContent = 'in ' + dur.days + ' days,' + dur.hours + ' hours';
          }

          // console.log('clone.querySelector(".bidAmount").children[0].value ', clone.querySelector(".bidAmount").children[0].value);
          // console.log('clone.querySelector(".bidAmount")children[0] ', clone.querySelector(".bidAmount").children[0]);

          auctionInfo.image = tokenMetadata.image.replace('ipfs://', 'https://ipfs.io/ipfs/');
          auctionInfo.tokenID = tokenID;
          auctionInfo.name = tokenMetadata.name;

          auctionsNormalized[index] = auctionInfo;
          await auctionsContainer.appendChild(clone);
          // var index = Array.prototype.indexOf.call(auctionsContainer, clone);
          // console.log('index ', index);
          index = index + 1;
        } else {
          alert("Ошибка HTTP: " + response.status);
        }
      }

    });

    await Promise.all(rowResolversAuction);

    // Display fully loaded UI for wallet data
    document.querySelector("#prepare").style.display = "none";
    document.querySelector("#connected").style.display = "block";
  }

  async function onCreateClick () {
    let url = "https://openbisea.io/auctioncreate-v2?tokenID=" + tokenIDsaved;
    if (contractSaved !== undefined) url = url + "&contract=" + contractSaved;
    window.open(url, '_blank').focus();
  }

  async function onCancelClick () {
    document.querySelector("#progress").style.display = "block";
    document.querySelector("#cancel-auction").disabled = true;

    let countDots = 0;
    let sendOrderStatus = setInterval(async function () {
      let phrase = "Transaction in progress " + ".".repeat(countDots);
      document.querySelector("#progress").textContent = phrase;
      countDots++;
      if (countDots === 4) countDots = 0;
    }, 1000);
    const web3 = new Web3(provider);
    const chainId = await web3.eth.getChainId();
    if (chainId !== 56 && chainId !== 97) {
      document.querySelector("#progress").textContent = "We support only BSC mainnet";
      document.querySelector("#cancel-auction").disabled = false;
      return;
    }

    const openbiseaABI = _openbiseaABI;
    let openbiseaAddress = '0x7b1AC460c155ABb6b1D02b543952426A6aaF6b72';
    if (chainId === 97) openbiseaAddress = "0x66Ddd56AB8F961a31Ef344086589D53Ee0b6944a";
    const openbiseaContract = new web3.eth.Contract(openbiseaABI, openbiseaAddress);
    let nftContractAddress = "0xb861DF245fc18483235D9C11b87d8A76F4678e08";
    if (chainId === 97) nftContractAddress = "0x4F59D55D1c91fFD3267d560C37605409A7c885b9";
    if (contractSaved !== undefined) {
      nftContractAddress = contractSaved
    }
    let cancelResult = await openbiseaContract.methods.cancelAuction(nftContractAddress, tokenIDsaved + "", false).send({
      from: selectedAccount,
      gas: 500000
    }).catch((err) => {
      console.log('err->' + JSON.stringify(err));
      document.querySelector("#progress").textContent = err.message;
      document.querySelector("#cancel-auction").disabled = false;
    });

    if (cancelResult !== undefined) {
      console.log('cancelResult:', cancelResult.transactionHash);
      // element.disabled = false;
      document.querySelector("#buy-obs-result").style.display = "inline-block";
      resultURL = "https://bscscan.com/tx/" + cancelResult.transactionHash
      if (chainId === 97) resultURL = "http://testnet.bscscan.com/tx/" + cancelResult.transactionHash
      document.querySelector("#progress").style.display = "none";
      document.querySelector("#cancel-auction").disabled = false;
    } else {
      // document.querySelector("#obsamount").textContent = "Result undefined";
      document.querySelector("#progress").style.display = "none";
    }
    clearInterval(sendOrderStatus);
  }

  async function onOpenImageClick (element) {
    console.log("row" + element.parentNode.parentNode.rowIndex + " - column" + element.parentNode.cellIndex);
    window.open(auctionsNormalized[element.parentNode.parentNode.rowIndex].image, '_blank').focus();
  }

  async function onAllowClick (element) {
    console.log("row" + element.parentNode.parentNode.rowIndex + " - column" + element.parentNode.cellIndex);
    const auctionInfo = auctionsNormalized[element.parentNode.parentNode.rowIndex];
    document.querySelector("#progress").style.display = "block";

    let countDots = 0;
    let sendOrderStatus = setInterval(async function () {
      let phrase = "Transaction in progress " + ".".repeat(countDots);
      document.querySelector("#progress").textContent = phrase;
      countDots++;
      if (countDots === 4) countDots = 0;
    }, 1000);
    const web3 = new Web3(provider);
    const chainId = await web3.eth.getChainId();
    if (chainId !== 56 && chainId !== 97) {
      document.querySelector("#progress").textContent = "We support only BSC mainnet";
      element.disabled = true;
      // document.querySelector("#progress").style.display = "none";
      return;
    }
    let openbiseaAddress = '0x7b1AC460c155ABb6b1D02b543952426A6aaF6b72';
    if (chainId === 97) openbiseaAddress = "0x66Ddd56AB8F961a31Ef344086589D53Ee0b6944a";

    let busdAddress = '0xe9e7cea3dedca5984780bafc599bd69add087d56';
    if (chainId === 97) busdAddress = "0x8301F2213c0eeD49a7E28Ae4c3e91722919B8B47";

    const busdABI = _busdABI;
    const busd = new web3.eth.Contract(JSON.parse(busdABI), busdAddress);

    const amountText = element.parentNode.parentNode.children[4].children[0].value;
    const amountDouble = parseFloat(amountText);
    if (amountDouble <= auctionInfo.priceDouble) {
      document.querySelector("#progress").textContent = "must be more than last bid";
      element.disabled = true;
      // document.querySelector("#progress").style.display = "none";
      return;
    }
    element.disabled = true;
    const purchaseAmount = Number(parseFloat(amountText) * (10 ** 18)).toFixed(0) + '';

    let approveResult = await busd.methods.approve(openbiseaAddress, purchaseAmount).send({
      from: selectedAccount
    }).catch((err) => {
      console.log('err->' + JSON.stringify(err));
      document.querySelector("#progress").textContent = err.message;
    });
    if (approveResult !== undefined) {
      console.log('bidResult:', approveResult.transactionHash);
      element.disabled = false;
      document.querySelector("#buy-obs-result").style.display = "inline-block";
      resultURL = "https://bscscan.com/tx/" + approveResult.transactionHash
      if (chainId === 97) resultURL = "http://testnet.bscscan.com/tx/" + approveResult.transactionHash
      document.querySelector("#progress").style.display = "none";
      element.parentNode.parentNode.children[6].children[0].removeAttribute("disabled");
      element.style.display = "none";
    } else {
      // document.querySelector("#obsamount").textContent = "Result undefined";
      document.querySelector("#progress").style.display = "none";
    }
    clearInterval(sendOrderStatus);

  }

  async function onBidClick (element) {
    // var element = event.target || event.srcElement;
    console.log("row" + element.parentNode.parentNode.rowIndex + " - column" + element.parentNode.cellIndex);
    const auctionInfo = auctionsNormalized[element.parentNode.parentNode.rowIndex];

    document.querySelector("#progress").style.display = "block";

    let countDots = 0;
    let sendOrderStatus = setInterval(async function () {
      let phrase = "Transaction in progress " + ".".repeat(countDots);
      document.querySelector("#progress").textContent = phrase;
      countDots++;
      if (countDots === 4) countDots = 0;
    }, 1000);
    const web3 = new Web3(provider);
    const chainId = await web3.eth.getChainId();
    if (chainId !== 56 && chainId !== 97) {
      document.querySelector("#progress").textContent = "We support only BSC mainnet";
      element.disabled = true;
      // document.querySelector("#progress").style.display = "none";
      return;
    }
    let openbiseaAddress = '0x7b1AC460c155ABb6b1D02b543952426A6aaF6b72';
    if (chainId === 97) openbiseaAddress = "0x66Ddd56AB8F961a31Ef344086589D53Ee0b6944a";
    const openbiseaABI = _openbiseaABI;
    const openbisea = new web3.eth.Contract(openbiseaABI, openbiseaAddress);

    console.log("1", element.parentNode.parentNode);
    console.log("2", element.parentNode.parentNode.children[4]);
    console.log("3", element.parentNode.parentNode.children[4].children[0]);

    const amountText = element.parentNode.parentNode.children[4].children[0].value;
    const amountDouble = parseFloat(amountText);
    if (amountDouble <= auctionInfo.priceDouble) {
      document.querySelector("#progress").textContent = "must be more than last bid";
      element.disabled = true;
      // document.querySelector("#progress").style.display = "none";
      return;
    }
    element.disabled = true;

    let nftContractAddress = "0xb861DF245fc18483235D9C11b87d8A76F4678e08";
    if (chainId === 97) nftContractAddress = "0x4F59D55D1c91fFD3267d560C37605409A7c885b9";
    if (contractSaved !== undefined) {
      nftContractAddress = contractSaved
    }
    const purchaseAmount = Number(parseFloat(amountText) * (10 ** 18)).toFixed(0) + '';
    let bidResult
    console.log("auctionInfo", auctionInfo);
    console.log("purchaseAmount", purchaseAmount);
    console.log("amountText", amountText);
    console.log("element.parentNode", element.parentNode);
    console.log("element.parentNode.parentNode", element.parentNode.parentNode);
    if (auctionInfo.isUSD === true) {
      // NEED allowance.
      bidResult = await openbisea.methods.bidUSD(nftContractAddress, auctionInfo.tokenID + "", purchaseAmount, false).send({
        from: selectedAccount,
        gas: 500000
      }).catch((err) => {
        console.log('err->' + JSON.stringify(err));
        document.querySelector("#progress").textContent = err.message;
      });
    } else {
      bidResult = await openbisea.methods.bid(nftContractAddress, auctionInfo.tokenID + "", false).send({
        from: selectedAccount,
        value: purchaseAmount,
        gas: 500000
      }).catch((err) => {
        console.log('err->' + JSON.stringify(err));
        document.querySelector("#progress").textContent = err.message;
      });
    }

    if (bidResult !== undefined) {
      console.log('bidResult:', bidResult.transactionHash);
      element.disabled = false;
      document.querySelector("#buy-obs-result").style.display = "inline-block";
      resultURL = "https://bscscan.com/tx/" + bidResult.transactionHash
      if (chainId === 97) resultURL = "http://testnet.bscscan.com/tx/" + bidResult.transactionHash
      document.querySelector("#progress").style.display = "none";
    } else {
      // document.querySelector("#obsamount").textContent = "Result undefined";
      document.querySelector("#progress").style.display = "none";
    }
    clearInterval(sendOrderStatus);
  }

  /**
   * Buy button pressed.
   */

  function getBase64 (file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
    });
  }

  async function onWhitelist () {
    // var element = event.target || event.srcElement;

    document.querySelector("#progress").style.display = "block";

    let countDots = 0;
    let sendOrderStatus = setInterval(async function () {
      let phrase = "Transaction in progress " + ".".repeat(countDots);
      document.querySelector("#progress").textContent = phrase;
      countDots++;
      if (countDots === 4) countDots = 0;
    }, 1000);
    const web3 = new Web3(provider);
    const chainId = await web3.eth.getChainId();
    if (chainId !== 56 && chainId !== 97) {
      document.querySelector("#progress").textContent = "We support only BSC mainnet";
      element.disabled = true;
      // document.querySelector("#progress").style.display = "none";
      return;
    }
    let openbiseaAddress = '0x7b1AC460c155ABb6b1D02b543952426A6aaF6b72';
    if (chainId === 97) openbiseaAddress = "0x66Ddd56AB8F961a31Ef344086589D53Ee0b6944a";
    const openbiseaABI = _openbiseaABI;
    const openbisea = new web3.eth.Contract(openbiseaABI, openbiseaAddress);

    let whitelistResult = await openbisea.methods.whitelistContractCreator(contractSaved).send({
        from: selectedAccount,
        gas: 500000,
        value: "88800000000000000"
      }).catch((err) => {
        console.log('err->' + JSON.stringify(err));
        document.querySelector("#progress").textContent = err.message;
      });

    if (whitelistResult !== undefined) {
      console.log('whitelistResult:', whitelistResult.transactionHash);
      document.querySelector("#buy-obs-result").style.display = "inline-block";
      resultURL = "https://bscscan.com/tx/" + whitelistResult.transactionHash
      if (chainId === 97) resultURL = "http://testnet.bscscan.com/tx/" + whitelistResult.transactionHash
      document.querySelector("#progress").style.display = "none";
    } else {
      // document.querySelector("#obsamount").textContent = "Result undefined";
      document.querySelector("#progress").style.display = "none";
    }
    clearInterval(sendOrderStatus);
  }

  /**
   * Main entry point.
   */
  window.addEventListener('load', async () => {
    //init();
    document.querySelector("#btn-connect").addEventListener("click", onConnect);
    document.querySelector("#btn-disconnect").addEventListener("click", onDisconnect);
    document.querySelector("#btn-whitelist").addEventListener("click", onWhitelist);
    document.querySelector("#buy-obs-result").addEventListener("click", onResultClick);
    document.querySelector("#create-auction").addEventListener("click", onCreateClick);
    document.querySelector("#cancel-auction").addEventListener("click", onCancelClick);
  });

  window.onload = function () {
    init()
  }
</script>
<script>
  (function () {

  })();
</script>