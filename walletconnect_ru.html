<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link type="text/css" rel="stylesheet" href="https://oleksiivinogradov.github.io/openbisea_frontend/all.css">

<div class="container" style="width:800px;">
    <div class="row">
        <div class="col-md-12">
            <h1>Купить токен OBS</h1>

            <div id="alert-error-https" class="alert alert-danger no_display">
                You can run this example only over HTTPS connection.
            </div>

            <div id="prepare">
                <p>Кошелек не подключен. Подключите кошелек чтобы увидить ваши аккаунты и балансы в BNB.</p>
                <button id="btn-connect" class="btn btn-primary black_on_yellow">
                    Подключить кошелек
                </button>
                <br><br>
            </div>

            <div id="connected" class="text-center no_display">
                <input type="text" id="amount" name="Amount" value="" placeholder="BNB amount" />
                <br>

                <span id="obsamount" class="clr_yellow"> </span>
                <br><br>

                <button id="buy-obs" class="btn btn-primary black_on_yellow" disabled> Купить токен OBS </button>
                <br>

                <span id="progress" class="clr_yellow no_display"> Транзакция обрабатывается ...</span>
                <br>

                <div id="resultstrans" class="text-center">
                    <button id="buy-obs-result" class="btn btn-primary black_on_white no_display"> Проверить статус транзакции </button>
                </div>

                <hr>

                <div id="network">
                    <p>
                        <strong>Сеть:</strong> <span id="network-name"></span>
                    </p>
                    <p>
                        <strong>Выбранный аккаунт:</strong> <span id="selected-account"></span>
                    </p>
                    <button id="btn-disconnect" class="btn btn-primary black_on_yellow">
                        Отключить кошелек
                    </button>
                </div>

                <hr>

                <h3>Балансы все аккаутов</h3>

                <table class="table table-listing">
                    <thead>
                        <th>Адрес</th>
                        <th>баланс BNB</th>
                    </thead>
                    <tbody id="accounts">
                    </tbody>
                </table>

                <p>Можете переключится между аккаунтами, еслм ваш кошелек поддерживает эту опцию.</p>
            </div>
        </div>
    </div>

    <!-- We use simple <template> templating for the example -->
    <div id="templates" class="no_display">
        <template id="template-balance">
            <tr>
                <th class="address"></th>
                <td class="balance"></td>
            </tr>
        </template>
    </div>
</div>

    <!--
      Use unpkg CDN to load all NPM packages to vanilla Javascript - read more at http://unpkg.com
      On your deployment, you properly either want to use a preprocessing tool like webpack
      to include these files, or extract NPM archives and manually host the files inside.
      TODO: Pin down all versions.
    -->

    <script type="text/javascript" src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
    <script type="text/javascript" src="https://unpkg.com/evm-chains@0.2.0/dist/umd/index.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@walletconnect/web3-provider@1.2.1/dist/umd/index.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/fortmatic@2.0.6/dist/fortmatic.js"></script>
    <script type="text/javascript" src="https://oleksiivinogradov.github.io/openbisea_frontend/all.js"></script>

    <script>
        "use strict";

        /**
         * Example JavaScript code that interacts with the page and Web3 wallets
         */

            // Unpkg imports
        const Web3Modal = window.Web3Modal.default;
        const WalletConnectProvider = window.WalletConnectProvider.default;
        const Fortmatic = window.Fortmatic;
        const evmChains = window.evmChains;

        // Web3modal instance
        let web3Modal

        // Chosen wallet provider given by the dialog window
        let provider;

        // Address of the selected account
        let selectedAccount;

        //bscan
        let resultURL;
        /**
         * Setup the orchestra
         */
        function init () {

            console.log("Initializing example");
            console.log("WalletConnectProvider is", WalletConnectProvider);
            console.log("Fortmatic is", Fortmatic);
            console.log("window.web3 is", window.web3, "window.ethereum is", window.ethereum);

            // Check that the web page is run in a secure context,
            // as otherwise MetaMask won't be available
            if (location.protocol !== 'https:') {
                // https://ethereum.stackexchange.com/a/62217/620
                const alert = document.querySelector("#alert-error-https");
                alert.style.display = "block";
                document.querySelector("#btn-connect").setAttribute("disabled", "disabled")
                return;
            }

            // Tell Web3modal what providers we have available.
            // Built-in web browser provider (only one can exist as a time)
            // like MetaMask, Brave or Opera is added automatically by Web3modal
            const providerOptions = {
                walletconnect: {
                    package: WalletConnectProvider,
                    options: {
                        // Mikko's test key - don't copy as your mileage may vary
                        infuraId: "bb7b522604e54a2f8ad251e7417b2355",
                    }
                },

                // fortmatic: {
                //   package: Fortmatic,
                //   options: {
                //     // Mikko's TESTNET api key
                //     key: "pk_test_391E26A3B43A3350"
                //   }
                // }
            };

            web3Modal = new Web3Modal({
                cacheProvider: false, // optional
                providerOptions, // required
                disableInjectedProvider: false, // optional. For MetaMask / Brave / Opera.
            });

            console.log("Web3Modal instance is", web3Modal);
        }

        /**
         * Kick in the UI action after Web3modal dialog has chosen a provider
         */
        async function fetchAccountData () {

            // Get a Web3 instance for the wallet
            const web3 = new Web3(provider);

            console.log("Web3 instance is", web3);

            // Get connected chain id from Ethereum node
            const chainId = await web3.eth.getChainId();
            // Load chain information over an HTTP API
            const chainData = evmChains.getChain(chainId);
            document.querySelector("#network-name").textContent = chainData.name;

            // Get list of accounts of the connected wallet
            const accounts = await web3.eth.getAccounts();

            // MetaMask does not give you all accounts, only the selected account
            console.log("Got accounts", accounts);
            selectedAccount = accounts[0];

            document.querySelector("#selected-account").textContent = selectedAccount;

            // Get a handl
            const template = document.querySelector("#template-balance");
            const accountContainer = document.querySelector("#accounts");

            // Purge UI elements any previously loaded accounts
            accountContainer.innerHTML = '';

            // Go through all accounts and get their ETH balance
            const rowResolvers = accounts.map(async (address) => {
                const balance = await web3.eth.getBalance(address);
                // ethBalance is a BigNumber instance
                // https://github.com/indutny/bn.js/
                const ethBalance = web3.utils.fromWei(balance, "ether");
                const humanFriendlyBalance = parseFloat(ethBalance).toFixed(4);
                // Fill in the templated row and put in the document
                const clone = template.content.cloneNode(true);
                clone.querySelector(".address").textContent = address;
                clone.querySelector(".balance").textContent = humanFriendlyBalance;
                accountContainer.appendChild(clone);
            });

            // Because rendering account does its own RPC commucation
            // with Ethereum node, we do not want to display any results
            // until data for all accounts is loaded
            await Promise.all(rowResolvers);

            // Display fully loaded UI for wallet data
            document.querySelector("#prepare").style.display = "none";
            document.querySelector("#connected").style.display = "block";
        }

        /**
         * Buy button pressed.
         */
        async function onBuy () {
            document.querySelector("#progress").style.display = "block";

            let countDots = 0;
            let sendOrderStatus = setInterval(async function () {
                let phrase = "Транзакция обрабатывается " + ".".repeat(countDots);
                document.querySelector("#progress").textContent = phrase;
                countDots++;
                if (countDots === 4) countDots = 0;
            }, 1000);
            const web3 = new Web3(provider);
            const chainId = await web3.eth.getChainId();
            if (chainId !== 56 && chainId !== 97) {
                document.querySelector("#obsamount").textContent = "Мы поддерживаем только сеть Binance Smart Chain mainnet";
                document.querySelector("#buy-obs").disabled = true;
                document.querySelector("#progress").style.display = "none";
                return;
            }
            let openbiseaAddress = '0x1Bf12f0650d8065fFCE3Cd9111feDEC21deF6825';
            if (chainId === 97) openbiseaAddress = "0x66Ddd56AB8F961a31Ef344086589D53Ee0b6944a";
            const openbiseaABI = _openbiseaABI;
            const openbisea = new web3.eth.Contract(openbiseaABI, openbiseaAddress);

            const amountText = document.querySelector("#amount").value;
            const amountDouble = parseFloat(amountText);
            if (amountDouble <= 0.1) {
                document.querySelector("#obsamount").textContent = "минимальная покупка должна быть больше 0.1BNB";
                document.querySelector("#buy-obs").disabled = true;
                document.querySelector("#progress").style.display = "none";
                return;
            }
            document.querySelector("#buy-obs").disabled = true;

            const purchaseAmount = parseFloat(amountText) * (10 ** 18) + '';
            let tokensForPurchaseAmountOBSResult = await openbisea.methods.purchaseTokensQuantityFor(purchaseAmount).call()
            console.log('tokensForPurchaseAmountOBSResult:', tokensForPurchaseAmountOBSResult);
            let purchaseTokensOBSResult = await openbisea.methods.purchaseTokens().send({
                from: selectedAccount,
                value: purchaseAmount,
                gas: 500000
            }).catch((err) => {
                console.log('err->' + JSON.stringify(err) );
                document.querySelector("#obsamount").textContent = err.message;
            });
            if (purchaseTokensOBSResult !== undefined) {
                console.log('purchaseTokensOBSResult:', purchaseTokensOBSResult.transactionHash);
                document.querySelector("#buy-obs").disabled = false;
                document.querySelector("#buy-obs-result").style.display = "inline-block";
                resultURL = "https://bscscan.com/tx/" + purchaseTokensOBSResult.transactionHash
                if (chainId === 97) resultURL = "http://testnet.bscscan.com/tx/" + purchaseTokensOBSResult.transactionHash
                document.querySelector("#progress").style.display = "none";
            } else {
                // document.querySelector("#obsamount").textContent = "Result undefined";
                document.querySelector("#progress").style.display = "none";
            }
            clearInterval(sendOrderStatus);
        }

        /**
         * Buy button pressed.
         */
        async function onAmountChange () {
            const web3 = new Web3(provider);
            const chainId = await web3.eth.getChainId();
            if (chainId !== 56 && chainId !== 97) {
                document.querySelector("#obsamount").textContent = "Мы поддерживаем только сеть Binance Smart Chain mainnet";
                document.querySelector("#buy-obs").disabled = true;
                return;
            }
            let openbiseaAddress = '0x1Bf12f0650d8065fFCE3Cd9111feDEC21deF6825';
            if (chainId === 97) openbiseaAddress = "0x66Ddd56AB8F961a31Ef344086589D53Ee0b6944a";
            const openbiseaABI = _openbiseaABI;
            const openbisea = new web3.eth.Contract(openbiseaABI, openbiseaAddress);
            const amountText = document.querySelector("#amount").value;
            const amountDouble = parseFloat(amountText);
            if (amountDouble <= 0.1) {
                document.querySelector("#obsamount").textContent = "минимальная покупка должна быть больше 0.1BNB";
                document.querySelector("#buy-obs").disabled = true;
                return;
            }
            const purchaseAmount = parseFloat(amountText) * (10 ** 18) + '';
            console.log('amount:', amountText);
            console.log('purchaseAmount:', purchaseAmount);

            let tokensForPurchaseAmountOBSResult = await openbisea.methods.purchaseTokensQuantityFor(purchaseAmount).call();
            console.log('tokensForPurchaseAmountOBSResult:', tokensForPurchaseAmountOBSResult);
            document.querySelector("#obsamount").textContent = "Вы получите:" + Number(parseFloat(tokensForPurchaseAmountOBSResult[0]) / (10 ** 18)).toFixed(2) + " OBS";
            document.querySelector("#buy-obs").disabled = false;
        }

        /**
         * Main entry point.
         */
        window.addEventListener('load', async () => {
            init();
            document.querySelector("#btn-connect").addEventListener("click", onConnect);
            document.querySelector("#btn-disconnect").addEventListener("click", onDisconnect);
            document.querySelector("#buy-obs").addEventListener("click", onBuy);
            document.querySelector("#amount").addEventListener("input", onAmountChange);
            document.querySelector("#buy-obs-result").addEventListener("click", onResultClick);
        });

        window.onload = function () {
            init()
        }
    </script>
    <script>
        (function () {

        })();
    </script>
